<!--
  index.html ‚Äì Interfaz frontend para gesti√≥n de usuarios (CRUD)

  Este archivo proporciona una interfaz de usuario para:
  ‚úÖ Crear usuarios
  ‚úÖ Listar todos los usuarios
  ‚úÖ Editar un usuario
  ‚úÖ Eliminar usuarios

  Se comunica con un backend REST API usando fetch() para enviar y recibir datos.
  El backend debe estar desplegado (por ejemplo, en Render), y su URL debe
  actualizarse donde corresponda (actualmente localhost).
-->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Crear Usuario</title>

  <!-- Enlace al archivo CSS externo para estilos -->
  <link rel="stylesheet" href="styles.css" />

  <!-- Viewport responsivo para m√≥viles -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body>
  <h1>Crear nuevo usuario</h1>

  <!-- Formulario para crear usuarios -->
  <form id="formulario">
    <!-- Campo de texto para nombre (m√≠nimo 3 caracteres) -->
    <input type="text" id="nombre" placeholder="Nombre" required minlength="3" />

    <!-- Campo num√©rico para edad (valores v√°lidos: 1 a 120 a√±os) -->
    <input type="number" id="edad" placeholder="Edad" required min="1" max="120" />

    <!-- Bot√≥n para enviar el formulario -->
    <button type="submit">Enviar</button>
  </form>

  <!-- Encabezado para la secci√≥n de usuarios listados -->
  <h2>Lista de usuarios</h2>

  <!-- Lista que se llena din√°micamente con los usuarios desde la API -->
  <ul id="lista-usuarios"></ul>

  <!-- Formulario oculto que aparece al editar un usuario -->
  <form id="form-editar" style="display: none;">
    <h2>Editar usuario</h2>

    <!-- Nuevos valores del usuario -->
    <input type="text" id="editar-nombre" placeholder="Nuevo nombre" required />
    <input type="number" id="editar-edad" placeholder="Nueva edad" required />

    <!-- Campo oculto para almacenar el ID del usuario a editar -->
    <input type="hidden" id="editar-id" />

    <button type="submit">Actualizar</button>
  </form>

  <script>
    // Al cargar la p√°gina, se llama a cargarUsuarios()
    window.onload = cargarUsuarios;

    // ‚úÖ FORMULARIO: Crear nuevo usuario
    const formulario = document.getElementById('formulario');
    formulario.addEventListener('submit', async (e) => {
      e.preventDefault(); // Evita recargar la p√°gina

      const nombre = document.getElementById('nombre').value.trim();
      const edad = document.getElementById('edad').value;

      // Validaciones m√≠nimas antes de enviar al backend
      if (nombre.length < 3 || isNaN(edad) || edad < 1 || edad > 120) {
        alert('‚ùå Datos inv√°lidos');
        return;
      }

      // Env√≠o de datos al backend (POST)
      const respuesta = await fetch('http://localhost:3000/usuarios', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nombre, edad })
      });

      const data = await respuesta.json();

      if (respuesta.ok) {
        alert('‚úÖ Usuario creado');
        cargarUsuarios(); // Actualiza la lista
      } else {
        alert('‚ùå Error: ' + data.error);
      }
    });

    // üì• FUNCI√ìN: Obtener y mostrar usuarios desde la base de datos
    async function cargarUsuarios() {
      const respuesta = await fetch('http://localhost:3000/usuarios');
      const data = await respuesta.json();

      const lista = document.getElementById('lista-usuarios');
      lista.innerHTML = ''; // Limpiar contenido anterior

      // Crear un <li> por cada usuario
      data.forEach(usuario => {
        const item = document.createElement('li');

        item.innerHTML = `
          <span class="usuario-info">${usuario.nombre} (${usuario.edad} a√±os)</span>
          <div class="botones">
            <button onclick="mostrarFormularioEdicion('${usuario._id}', '${usuario.nombre}', ${usuario.edad})">Editar&nbsp;&nbsp;&nbsp;üñäÔ∏è</button>
            <button onclick="eliminarUsuario('${usuario._id}')">Eliminar&nbsp;&nbsp;&nbsp;‚úñÔ∏è</button>
          </div>
        `;

        lista.appendChild(item);
      });
    }

    // ‚úèÔ∏è FUNCI√ìN: Mostrar formulario de edici√≥n con valores actuales
    function mostrarFormularioEdicion(id, nombre, edad) {
      document.getElementById('editar-nombre').value = nombre;
      document.getElementById('editar-edad').value = edad;
      document.getElementById('editar-id').value = id;
      document.getElementById('form-editar').style.display = 'block';
    }

    // üì§ FORMULARIO: Enviar actualizaci√≥n de usuario al backend
    document.getElementById('form-editar').addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = document.getElementById('editar-id').value;
      const nombre = document.getElementById('editar-nombre').value;
      const edad = document.getElementById('editar-edad').value;

      const res = await fetch(`http://localhost:3000/usuarios/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nombre, edad })
      });

      const data = await res.json();

      if (res.ok) {
        alert('‚úÖ Usuario actualizado');
        document.getElementById('form-editar').style.display = 'none';
        cargarUsuarios();
      } else {
        alert('‚ùå Error al actualizar: ' + data.error);
      }
    });

    // üóëÔ∏è FUNCI√ìN: Eliminar usuario por ID
    function eliminarUsuario(id) {
      if (!confirm('¬øEst√°s seguro de eliminar este usuario?')) return;

      fetch(`http://localhost:3000/usuarios/${id}`, {
        method: 'DELETE'
      })
      .then(res => res.json())
      .then(data => {
        alert(`üóëÔ∏è ${data.mensaje}`);
        cargarUsuarios();
      })
      .catch(err => {
        alert('‚ùå Error al eliminar: ' + err.message);
      });
    }
  </script>
</body>
</html>
